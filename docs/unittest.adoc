= Working with unittest
:toc: left
:toclevels: 3
:sectnums:
:icons: font
:source-highlighter: highlight.js

== Introduction

While SysBot is primarily designed for Robot Framework, it can also be used effectively with Python's built-in unittest framework. This guide demonstrates how to integrate SysBot into your unittest test suites.

== Basic Setup

=== Simple Test Class

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestSysBot(unittest.TestCase):
    
    def setUp(self):
        """Set up test fixtures before each test method."""
        self.bot = Sysbot()
    
    def tearDown(self):
        """Clean up after each test method."""
        self.bot.close_all_sessions()
    
    def test_ssh_connection(self):
        """Test SSH connection to remote server."""
        self.bot.open_session(
            alias="test_server",
            protocol="ssh",
            product="bash",
            host="192.168.1.100",
            port=22,
            login="testuser",
            password="testpass"
        )
        
        result = self.bot.execute_command("test_server", "hostname")
        self.assertEqual(result["StatusCode"], 0)
        self.assertIsNotNone(result["Result"])


if __name__ == '__main__':
    unittest.main()
----

=== Using setUpClass and tearDownClass

For tests that share the same session across multiple test methods:

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestLinuxServer(unittest.TestCase):
    
    @classmethod
    def setUpClass(cls):
        """Set up class fixtures once for all test methods."""
        cls.bot = Sysbot()
        cls.bot.open_session(
            alias="linux_server",
            protocol="ssh",
            product="bash",
            host="192.168.1.100",
            port=22,
            login="testuser",
            password="testpass"
        )
    
    @classmethod
    def tearDownClass(cls):
        """Clean up class fixtures after all test methods."""
        cls.bot.close_all_sessions()
    
    def test_check_hostname(self):
        """Test hostname command."""
        result = self.bot.execute_command("linux_server", "hostname")
        self.assertEqual(result["StatusCode"], 0)
        self.assertIn("server", result["Result"].lower())
    
    def test_check_uptime(self):
        """Test uptime command."""
        result = self.bot.execute_command("linux_server", "uptime")
        self.assertEqual(result["StatusCode"], 0)
        self.assertIsNotNone(result["Result"])
    
    def test_check_disk_space(self):
        """Test disk space command."""
        result = self.bot.execute_command("linux_server", "df -h")
        self.assertEqual(result["StatusCode"], 0)
        self.assertIn("/", result["Result"])


if __name__ == '__main__':
    unittest.main()
----

== Testing Different Protocols

=== SSH Tests

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestSSHConnections(unittest.TestCase):
    
    def setUp(self):
        self.bot = Sysbot()
    
    def tearDown(self):
        self.bot.close_all_sessions()
    
    def test_linux_bash(self):
        """Test Linux SSH with Bash."""
        self.bot.open_session(
            alias="linux",
            protocol="ssh",
            product="bash",
            host="192.168.1.100",
            port=22,
            login="user",
            password="pass"
        )
        
        result = self.bot.execute_command("linux", "uname -a")
        self.assertEqual(result["StatusCode"], 0)
        self.assertIn("Linux", result["Result"])
    
    def test_linux_powershell_over_ssh(self):
        """Test PowerShell over SSH."""
        self.bot.open_session(
            alias="linux_pwsh",
            protocol="ssh",
            product="powershell",
            host="192.168.1.100",
            port=22,
            login="user",
            password="pass"
        )
        
        result = self.bot.execute_command("linux_pwsh", "$PSVersionTable")
        self.assertEqual(result["StatusCode"], 0)


if __name__ == '__main__':
    unittest.main()
----

=== WinRM Tests

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestWinRMConnections(unittest.TestCase):
    
    def setUp(self):
        self.bot = Sysbot()
    
    def tearDown(self):
        self.bot.close_all_sessions()
    
    def test_windows_powershell(self):
        """Test Windows WinRM with PowerShell."""
        self.bot.open_session(
            alias="windows",
            protocol="winrm",
            product="powershell",
            host="192.168.1.200",
            port=5986,
            login="Administrator",
            password="P@ssw0rd"
        )
        
        result = self.bot.execute_command("windows", "Get-ComputerInfo | Select-Object CsName")
        self.assertEqual(result["StatusCode"], 0)
        self.assertIsNotNone(result["Result"])
    
    def test_windows_services(self):
        """Test Windows service listing."""
        self.bot.open_session(
            alias="windows",
            protocol="winrm",
            product="powershell",
            host="192.168.1.200",
            port=5986,
            login="Administrator",
            password="P@ssw0rd"
        )
        
        result = self.bot.execute_command("windows", "Get-Service | Select-Object -First 5")
        self.assertEqual(result["StatusCode"], 0)


if __name__ == '__main__':
    unittest.main()
----

=== HTTP Tests

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestHTTPConnections(unittest.TestCase):
    
    def setUp(self):
        self.bot = Sysbot()
    
    def tearDown(self):
        self.bot.close_all_sessions()
    
    def test_api_connection(self):
        """Test HTTP API connection."""
        self.bot.open_session(
            alias="api",
            protocol="http",
            product="basicauth",
            host="api.example.com",
            port=443,
            login="apiuser",
            password="apikey"
        )
        
        result = self.bot.execute_command("api", "/api/v1/health")
        self.assertEqual(result["StatusCode"], 0)
    
    def test_vsphere_connection(self):
        """Test vSphere connection."""
        self.bot.open_session(
            alias="vcenter",
            protocol="http",
            product="vsphere",
            host="vcenter.example.com",
            port=443,
            login="administrator@vsphere.local",
            password="password"
        )
        
        # Test connection is established
        # Actual vSphere operations would go here
        self.assertIsNotNone(self.bot)


if __name__ == '__main__':
    unittest.main()
----

== Using Secret Management

=== Basic Secret Tests

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestSecretManagement(unittest.TestCase):
    
    def setUp(self):
        self.bot = Sysbot()
    
    def tearDown(self):
        # Clean up any secrets created during tests
        try:
            self.bot.remove_secret("test_secret")
        except KeyError:
            pass
        self.bot.close_all_sessions()
    
    def test_add_get_secret(self):
        """Test adding and retrieving a secret."""
        self.bot.add_secret("test_secret", "secret_value")
        value = self.bot.get_secret("test_secret")
        self.assertEqual(value, "secret_value")
    
    def test_remove_secret(self):
        """Test removing a secret."""
        self.bot.add_secret("test_secret", "secret_value")
        self.bot.remove_secret("test_secret")
        
        with self.assertRaises(KeyError):
            self.bot.get_secret("test_secret")
    
    def test_get_nonexistent_secret(self):
        """Test getting a secret that doesn't exist."""
        with self.assertRaises(KeyError):
            self.bot.get_secret("nonexistent_secret")


if __name__ == '__main__':
    unittest.main()
----

=== Using Secrets for Connections

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestSecretsInConnections(unittest.TestCase):
    
    @classmethod
    def setUpClass(cls):
        cls.bot = Sysbot()
        # Load configuration from YAML into secrets
        cls.bot.plugins.data.yaml("tests/config.yml", key="config")
    
    @classmethod
    def tearDownClass(cls):
        cls.bot.close_all_sessions()
    
    def test_connection_with_secrets(self):
        """Test connection using credentials from secrets."""
        host = self.bot.get_secret("config.server.host")
        username = self.bot.get_secret("config.server.username")
        password = self.bot.get_secret("config.server.password")
        
        self.bot.open_session(
            alias="secure_server",
            protocol="ssh",
            product="bash",
            host=host,
            port=22,
            login=username,
            password=password
        )
        
        result = self.bot.execute_command("secure_server", "whoami")
        self.assertEqual(result["StatusCode"], 0)


if __name__ == '__main__':
    unittest.main()
----

== Using Data Plugins

=== CSV Data Tests

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestCSVDataPlugin(unittest.TestCase):
    
    def setUp(self):
        self.bot = Sysbot()
    
    def test_load_csv_without_secret(self):
        """Test loading CSV data without storing as secret."""
        data = self.bot.plugins.data.csv("tests/data.csv")
        self.assertIsInstance(data, list)
        self.assertEqual(data[0]["id"], "1")
        self.assertEqual(data[0]["name"], "Alice")
    
    def test_load_csv_with_secret(self):
        """Test loading CSV data and storing as secret."""
        result = self.bot.plugins.data.csv("tests/data.csv", key="csv_data")
        self.assertEqual(result, "Imported")
        
        # Access via secret manager
        id_value = self.bot.get_secret("csv_data.0.id")
        name_value = self.bot.get_secret("csv_data.0.name")
        
        self.assertEqual(id_value, "1")
        self.assertEqual(name_value, "Alice")


if __name__ == '__main__':
    unittest.main()
----

=== YAML/JSON Data Tests

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestDataPlugins(unittest.TestCase):
    
    def setUp(self):
        self.bot = Sysbot()
    
    def test_load_yaml(self):
        """Test loading YAML data."""
        data = self.bot.plugins.data.yaml("tests/config.yml")
        self.assertIsInstance(data, dict)
        self.assertIn("database", data)
    
    def test_load_json(self):
        """Test loading JSON data."""
        data = self.bot.plugins.data.json("tests/data.json")
        self.assertIsInstance(data, dict)
        self.assertIn("users", data)
    
    def test_yaml_with_secret(self):
        """Test loading YAML data as secret."""
        result = self.bot.plugins.data.yaml("tests/config.yml", key="config")
        self.assertEqual(result, "Imported")
        
        db_host = self.bot.get_secret("config.database.host")
        self.assertIsNotNone(db_host)


if __name__ == '__main__':
    unittest.main()
----

== Using Modules

=== Testing with Specific Modules

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestLinuxModules(unittest.TestCase):
    
    @classmethod
    def setUpClass(cls):
        # Load only specific modules
        cls.bot = Sysbot("linux.systemd", "linux.file")
        cls.bot.open_session(
            alias="linux_server",
            protocol="ssh",
            product="bash",
            host="192.168.1.100",
            port=22,
            login="user",
            password="pass"
        )
    
    @classmethod
    def tearDownClass(cls):
        cls.bot.close_all_sessions()
    
    def test_file_exists(self):
        """Test file.exists module function."""
        exists = self.bot.linux.file.exists("linux_server", "/etc/hosts")
        self.assertTrue(exists)
    
    def test_systemd_list_units(self):
        """Test systemd.list_units module function."""
        units = self.bot.linux.systemd.list_units("linux_server")
        self.assertIsNotNone(units)
        self.assertIsInstance(units, (list, dict))


if __name__ == '__main__':
    unittest.main()
----

=== Testing All Modules

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestAllModules(unittest.TestCase):
    
    @classmethod
    def setUpClass(cls):
        # Load all modules
        cls.bot = Sysbot()
        cls.bot.open_session(
            alias="server",
            protocol="ssh",
            product="bash",
            host="192.168.1.100",
            port=22,
            login="user",
            password="pass"
        )
    
    @classmethod
    def tearDownClass(cls):
        cls.bot.close_all_sessions()
    
    def test_multiple_modules(self):
        """Test multiple module functions."""
        # File module
        exists = self.bot.linux.file.exists("server", "/etc")
        self.assertTrue(exists)
        
        # Additional module tests here
        # self.bot.linux.systemd.list_units("server")
        # self.bot.linux.dnf.repolist("server")


if __name__ == '__main__':
    unittest.main()
----

== SSH Tunneling Tests

=== Single Tunnel

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestSSHTunnel(unittest.TestCase):
    
    def setUp(self):
        self.bot = Sysbot()
    
    def tearDown(self):
        self.bot.close_all_sessions()
    
    def test_single_tunnel(self):
        """Test SSH connection through single tunnel."""
        tunnel_config = [
            {
                "ip": "192.168.1.1",
                "port": 22,
                "username": "jumphost_user",
                "password": "jumphost_pass"
            }
        ]
        
        self.bot.open_session(
            alias="tunneled_server",
            protocol="ssh",
            product="bash",
            host="10.0.0.100",
            port=22,
            login="target_user",
            password="target_pass",
            tunnel_config=tunnel_config
        )
        
        result = self.bot.execute_command("tunneled_server", "hostname")
        self.assertEqual(result["StatusCode"], 0)


if __name__ == '__main__':
    unittest.main()
----

=== Nested Tunnels

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestNestedTunnels(unittest.TestCase):
    
    def setUp(self):
        self.bot = Sysbot()
    
    def tearDown(self):
        self.bot.close_all_sessions()
    
    def test_nested_tunnels(self):
        """Test SSH connection through nested tunnels."""
        tunnel_config = [
            {
                "ip": "192.168.1.1",
                "port": 22,
                "username": "user1",
                "password": "pass1"
            },
            {
                "ip": "192.168.2.1",
                "port": 22,
                "username": "user2",
                "password": "pass2"
            },
            {
                "ip": "192.168.3.1",
                "port": 22,
                "username": "user3",
                "password": "pass3"
            }
        ]
        
        self.bot.open_session(
            alias="deep_server",
            protocol="ssh",
            product="bash",
            host="10.0.0.50",
            port=22,
            login="final_user",
            password="final_pass",
            tunnel_config=tunnel_config
        )
        
        result = self.bot.execute_command("deep_server", "hostname")
        self.assertEqual(result["StatusCode"], 0)


if __name__ == '__main__':
    unittest.main()
----

== Test Organization

=== Test Suite Organization

[source,python]
----
import unittest
from test_ssh import TestSSHConnections
from test_winrm import TestWinRMConnections
from test_secrets import TestSecretManagement
from test_modules import TestLinuxModules


def suite():
    """Create a test suite combining all test cases."""
    test_suite = unittest.TestSuite()
    
    # Add test classes
    test_suite.addTests(unittest.TestLoader().loadTestsFromTestCase(TestSSHConnections))
    test_suite.addTests(unittest.TestLoader().loadTestsFromTestCase(TestWinRMConnections))
    test_suite.addTests(unittest.TestLoader().loadTestsFromTestCase(TestSecretManagement))
    test_suite.addTests(unittest.TestLoader().loadTestsFromTestCase(TestLinuxModules))
    
    return test_suite


if __name__ == '__main__':
    runner = unittest.TextTestRunner(verbosity=2)
    runner.run(suite())
----

=== Using Test Decorators

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class TestWithDecorators(unittest.TestCase):
    
    def setUp(self):
        self.bot = Sysbot()
    
    def tearDown(self):
        self.bot.close_all_sessions()
    
    @unittest.skip("Skipping this test temporarily")
    def test_skipped(self):
        """This test is skipped."""
        pass
    
    @unittest.skipIf(not hasattr(Sysbot, 'plugins'), "Plugins not available")
    def test_conditional_skip(self):
        """This test runs only if condition is met."""
        self.assertIsNotNone(self.bot.plugins)
    
    @unittest.expectedFailure
    def test_expected_failure(self):
        """This test is expected to fail."""
        self.fail("This test is expected to fail")


if __name__ == '__main__':
    unittest.main()
----

== Helper Functions

=== Creating Test Helpers

[source,python]
----
import unittest
from sysbot.Sysbot import Sysbot


class SysBotTestCase(unittest.TestCase):
    """Base test case class with helper methods."""
    
    def setUp(self):
        self.bot = Sysbot()
    
    def tearDown(self):
        self.bot.close_all_sessions()
    
    def open_linux_session(self, alias, host, user, password, port=22):
        """Helper to open Linux SSH session."""
        self.bot.open_session(
            alias=alias,
            protocol="ssh",
            product="bash",
            host=host,
            port=port,
            login=user,
            password=password
        )
    
    def open_windows_session(self, alias, host, user, password, port=5986):
        """Helper to open Windows WinRM session."""
        self.bot.open_session(
            alias=alias,
            protocol="winrm",
            product="powershell",
            host=host,
            port=port,
            login=user,
            password=password
        )
    
    def assert_command_success(self, result):
        """Assert command executed successfully."""
        self.assertEqual(result["StatusCode"], 0)
        self.assertIsNotNone(result["Result"])
        self.assertEqual(result["Error"], "")
    
    def execute_and_verify(self, alias, command):
        """Execute command and verify it succeeded."""
        result = self.bot.execute_command(alias, command)
        self.assert_command_success(result)
        return result


class TestWithHelpers(SysBotTestCase):
    """Tests using helper methods."""
    
    def test_linux_with_helper(self):
        """Test using helper methods."""
        self.open_linux_session(
            alias="server",
            host="192.168.1.100",
            user="testuser",
            password="testpass"
        )
        
        result = self.execute_and_verify("server", "hostname")
        self.assertIsNotNone(result["Result"])


if __name__ == '__main__':
    unittest.main()
----

== Running Tests

=== Command Line Execution

[source,bash]
----
# Run all tests in a file
python -m unittest test_sysbot.py

# Run all tests in a directory
python -m unittest discover -s tests/

# Run specific test class
python -m unittest test_sysbot.TestSSHConnections

# Run specific test method
python -m unittest test_sysbot.TestSSHConnections.test_linux_bash

# Run with verbose output
python -m unittest -v test_sysbot.py
----

=== Using pytest (Alternative)

If you prefer pytest over unittest:

[source,bash]
----
# Install pytest
pip install pytest

# Run tests with pytest
pytest tests/

# Run with verbose output
pytest -v tests/

# Run specific test file
pytest tests/test_sysbot.py

# Run with coverage
pytest --cov=sysbot tests/
----

== Best Practices

=== Use setUp and tearDown

Always clean up resources in tearDown:

[source,python]
----
def tearDown(self):
    """Always close sessions in tearDown."""
    self.bot.close_all_sessions()
----

=== Test Isolation

Each test should be independent:

[source,python]
----
def setUp(self):
    """Create fresh instance for each test."""
    self.bot = Sysbot()
----

=== Meaningful Test Names

[source,python]
----
# Good: descriptive test names
def test_ssh_connection_establishes_successfully(self):
    pass

def test_command_execution_returns_expected_output(self):
    pass

# Bad: unclear test names
def test_1(self):
    pass

def test_stuff(self):
    pass
----

=== Use Assertions Appropriately

[source,python]
----
# Good: specific assertions
self.assertEqual(result["StatusCode"], 0)
self.assertIn("expected", result["Result"])
self.assertTrue(file_exists)

# Bad: generic assertions
self.assertTrue(result)  # What are we testing?
----

=== Document Your Tests

[source,python]
----
def test_ssh_connection(self):
    """
    Test SSH connection to Linux server.
    
    Verifies that:
    - Connection can be established
    - Commands can be executed
    - Results are returned correctly
    """
    pass
----

== Next Steps

. Read the link:developer.adoc[Developer Guide] for creating custom modules
. Check link:references.adoc[API References] for detailed documentation
. Explore link:robotframework.adoc[Robot Framework Integration] for alternative testing

== Additional Resources

* Python unittest documentation: https://docs.python.org/3/library/unittest.html
* pytest documentation: https://docs.pytest.org/
* SysBot GitHub: https://github.com/JoReci2/sysbot

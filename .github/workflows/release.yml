name: Release

on:
  push:
    tags:
      - '*.*.*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: |
          python -m build
          
      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Publish to GitHub Packages
          # GitHub Packages for Python requires package name to match repo
          python -m pip install --upgrade twine
          twine upload --repository-url https://maven.pkg.github.com/${{ github.repository_owner }} dist/* || echo "Package publication skipped or failed"
        continue-on-error: true

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: ./
          artifact-name: sbom-sysbot.spdx.json
          output-file: sbom-sysbot.spdx.json

      - name: Run vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'vulnerability-report.json'

      - name: Run vulnerability scan (table format)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          output: 'vulnerability-report.txt'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Antora and asciidoctor-pdf
        run: |
          npm install -g @antora/cli@3.1 @antora/site-generator@3.1
          sudo apt-get update
          sudo apt-get install -y ruby-asciidoctor-pdf

      - name: Generate PDF documentation
        run: |
          # Build documentation with Antora if playbook exists
          if [ -f "antora-playbook.yml" ]; then
            antora --fetch antora-playbook.yml
            
            # Find all AsciiDoc files in the Antora build and create a combined PDF
            if [ -d "build/site" ]; then
              # Create a master document for PDF generation
              cd docs
              if [ -f "index.adoc" ]; then
                cat > complete-documentation.adoc << 'EOF'
          = SysBot - Complete Documentation
          :doctype: book
          :toc: left
          :toclevels: 3
          :sectnums:
          :icons: font
          :source-highlighter: highlight.js
          
          include::index.adoc[leveloffset=+1]
          
          include::setup.adoc[leveloffset=+1]
          
          include::quickstart.adoc[leveloffset=+1]
          
          include::robotframework.adoc[leveloffset=+1]
          
          include::unittest.adoc[leveloffset=+1]
          
          include::developer.adoc[leveloffset=+1]
          
          include::references.adoc[leveloffset=+1]
          EOF
                
                # Generate PDF from master document
                asciidoctor-pdf -o ../documentation.pdf complete-documentation.adoc
              else
                echo "Warning: index.adoc not found, creating placeholder"
                cat > ../documentation.txt << 'DOCEOF'
          Documentation Not Available
          
          The documentation source files were not found.
          Please refer to the project README for basic information.
          DOCEOF
              fi
            else
              echo "Warning: Antora build directory not found"
              cat > documentation.txt << 'DOCEOF'
          Documentation Not Available
          
          The Antora build did not complete successfully.
          Please refer to the project README for basic information.
          DOCEOF
            fi
          else
            # Fallback: use direct AsciiDoc if Antora playbook doesn't exist
            cd docs
            if [ -f "index.adoc" ]; then
              cat > complete-documentation.adoc << 'EOF'
          = SysBot - Complete Documentation
          :doctype: book
          :toc: left
          :toclevels: 3
          :sectnums:
          :icons: font
          :source-highlighter: highlight.js
          
          include::index.adoc[leveloffset=+1]
          
          include::setup.adoc[leveloffset=+1]
          
          include::quickstart.adoc[leveloffset=+1]
          
          include::robotframework.adoc[leveloffset=+1]
          
          include::unittest.adoc[leveloffset=+1]
          
          include::developer.adoc[leveloffset=+1]
          
          include::references.adoc[leveloffset=+1]
          EOF
              
              asciidoctor-pdf -o ../documentation.pdf complete-documentation.adoc
            else
              echo "Warning: No documentation found"
              cat > ../documentation.txt << 'DOCEOF'
          Documentation Not Available
          
          Neither antora-playbook.yml nor docs/index.adoc were found.
          Please refer to the project README for basic information.
          DOCEOF
            fi
          fi

      - name: Get milestone issues
        id: milestone
        run: |
          # Extract version from tag (tags are now XX.XX.XX format without 'v' prefix)
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Find milestone by version
          MILESTONE=$(gh api repos/${{ github.repository }}/milestones --jq ".[] | select(.title == \"$VERSION\") | .number")
          
          if [ -n "$MILESTONE" ]; then
            echo "milestone=$MILESTONE" >> $GITHUB_OUTPUT
            
            # Get issues from milestone
            gh api repos/${{ github.repository }}/issues \
              --method GET \
              -f milestone="$MILESTONE" \
              -f state=all \
              --jq '.[] | "- #\(.number): \(.title)"' > milestone-issues.txt
          else
            echo "No milestone found for version $VERSION"
            echo "No milestone issues" > milestone-issues.txt
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release-notes.md << 'EOF'
          ## Release Notes
          
          ### Changes in this release
          
          EOF
          
          if [ -f milestone-issues.txt ]; then
            cat milestone-issues.txt >> release-notes.md
          fi
          
          cat >> release-notes.md << 'EOF'
          
          ### Artifacts
          
          - Python Package (dist/)
          - SBOM (sbom-sysbot.spdx.json)
          - Vulnerability Analysis (vulnerability-report.txt)
          - Documentation (documentation.pdf or documentation.txt)
          
          ### Installation
          
          ```bash
          pip install sysbot==${{ steps.milestone.outputs.version || github.ref_name }}
          ```
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          files: |
            dist/*
            sbom-sysbot.spdx.json
            vulnerability-report.json
            vulnerability-report.txt
            documentation.pdf
            documentation.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
